version: "3.1"

stories:

- story: tell time
  steps:
  - intent: user_ask_time
  - action: action_set_name_slots
  - action: action_log_slots
  - action: action_tell_time

- story: tell name
  steps:
  - intent: user_ask_name
  - action: action_set_name_slots
  - action: action_log_slots
  - action: utter_tell_name

- story: say goodbye
  steps:
  - intent: user_goodbye
  - action: action_set_name_slots
  - action: action_log_slots
  - action: utter_goodbye

- story: personalized greeting
  steps:
  - intent: user_greet
  - action: action_set_name_slots
  - action: action_set_part_of_day
  - action: action_log_slots
  - action: utter_greet_personalized

- story: enrollment triggered - ask name after affirm or deny
  steps:
  - intent: trigger_enrollment
  - action: utter_ask_familar
  - or:
    - intent: affirm  # Path 1: User says yes
    - intent: deny   # Path 2: User says no
  - action: utter_ask_full_name # The common action after either path

- story: enrollment triggered - user provides name immediately
  steps:
  - intent: trigger_enrollment
  - action: utter_ask_familar
  - intent: provide_name  # User says "Yes, I'm John Smith"
  - action: name_collection_form  # Skip asking, go straight to form
  - active_loop: name_collection_form

# These continuation stories work from ANY entry point to the form
- story: name collection complete - spelling confirmed correct
  steps:
  # Form has just finished collecting firstname and surname
  - active_loop: name_collection_form
  - active_loop: null  # Form just completed
  # Prepare formatted spellings for confirmation
  - action: action_confirm_full_name
    # Sets: firstname_spelled = "J-O-H-N", surname_spelled = "S-M-I-T-H", spelling_stage = "confirming_both"
  - action: utter_ask_confirm_full_name   # Ask user to confirm the full name
    # Bot: "John Smith. Did I get that right?"
  # User confirms the name is correct
  - intent: affirm # User: "Yes"
  # Handle confirmation, move to spelling details check
  - action: action_handle_spelling_confirmation
    # Bot: "Did I spell everything correctly?"
    # Sets: spelling_stage = "confirming_spelling"
  # User confirms spelling is also correct
  - intent: affirm # User: "Yes"
  # Handle final confirmation
  - action: action_handle_spelling_confirmation
    # Bot: "Great!"
    # Sets: spelling_stage = "complete"
    # Sets: name_complete = True
  # Combine names into imprint_name for database query
  - action: action_set_imprint_name
    # Sets: imprint_name = "John_Smith"
  # Now back to wherever you came from (enrollment, profile update, etc.)

- story: name collection complete - need spelling correction
  steps:
  # Form has just finished collecting firstname and surname
  - active_loop: name_collection_form
  - active_loop: null
  # Prepare formatted spellings for confirmation
  - action: action_confirm_full_name
    # Sets: firstname_spelled = "N-A-T-H-A-N-I-E-L"
    # Sets: surname_spelled = "W-A-R-R-E-N"
    # Sets: spelling_stage = "confirming_both"
  # Ask user to confirm the full name
  - action: utter_ask_confirm_full_name
    # Bot: "Nathaniel Warren. Did I get that right?"
  # User confirms the name pronunciation is correct
  - intent: affirm # User: "Yes"
  # Handle confirmation, move to spelling details check
  - action: action_handle_spelling_confirmation
    # Bot: "Did I spell everything correctly?"
    # Sets: spelling_stage = "confirming_spelling"
  # User denies - spelling is wrong
  - intent: deny # User: "No"
  #- or:
  #  - intent: deny # User: "No" (it's actually "Nathanael" not "Nathaniel")
  #  - intent: nlu_fallback
  # Handle denial, ask for letter-by-letter spelling
  - action: action_handle_spelling_confirmation
    # Bot: "Can you spell your first name letter-by-letter?"
    # Sets: spelling_stage = "spelling_first"
  # User spells their first name
  - intent: spell_name # User: "N-A-T-H-A-N-A-E-L"
  # Process the spelling correction
  - action: action_process_spelling
    # Sets: imprint_firstname = "Nathanael"
    # Sets: firstname_spelled = "N-A-T-H-A-N-A-E-L"
    # Sets: spelling_stage = "confirming_first"
  # Confirm the corrected first name spelling
  - action: utter_confirm_firstname_spelling
    # Bot: "Nathanael, spelled N-A-T-H-A-N-A-E-L. Did I get that right?"
  # User confirms first name is correct
  - intent: affirm # User: "Yes"
  # Handle confirmation, move to surname spelling
  - action: action_handle_spelling_confirmation
    # Bot: "Can you spell your last name letter-by-letter?"
    # Sets: spelling_stage = "spelling_last"
  # User spells their surname
  - intent: spell_name # User: "W-A-R-R-E-N"
  # Process the surname spelling
  - action: action_process_spelling
    # Sets: imprint_surname = "Warren"
    # Sets: surname_spelled = "W-A-R-R-E-N"
    # Sets: spelling_stage = "confirming_last"
  # Confirm the surname spelling
  - action: utter_confirm_surname_spelling
    # Bot: "Warren, spelled W-A-R-R-E-N. Did I get that right?"
  # User confirms surname is correct
  - intent: affirm # User: "Yes"
  # Handle final confirmation
  - action: action_handle_spelling_confirmation
    # Bot: "Great!"
    # Sets: spelling_stage = "complete"
    # Sets: name_complete = True
  # Combine corrected names into imprint_name for database query
  - action: action_set_imprint_name
    # Sets: imprint_name = "Nathanael_Warren"

- story: name collection complete - name wrong, jump to spelling
  steps:
  # Form has just finished collecting firstname and surname
  - active_loop: name_collection_form
  - active_loop: null
  # Prepare formatted spellings for confirmation
  - action: action_confirm_full_name
    # Sets: firstname_spelled = "N-A-T-H-A-N-I-E-L"
    # Sets: surname_spelled = "W-A-R-R-E-N"
    # Sets: spelling_stage = "confirming_both"
  # Ask user to confirm the full name
  - action: utter_ask_confirm_full_name
    # Bot: "Nathaniel Warren. Did I get that right?"
  # User denies - spelling is wrong
  - intent: deny # User: "No"
  #- or:
  #  - intent: deny # User: "No"
  #  - intent: nlu_fallback
  # Apologize and jump straight to firstname spelling
  - action: action_handle_spelling_confirmation
    # Bot: "My apologies. Can you spell your first name letter-by-letter?"
    # Sets: spelling_stage = "spelling_first"
  # User spells firstname
  - intent: spell_name # User: "N-A-T-H-A-N-A-E-L"
  # Process the spelling correction
  - action: action_process_spelling
    # Sets: imprint_firstname = "Nathanael"
    # Sets: firstname_spelled = "N-A-T-H-A-N-A-E-L"
    # Sets: spelling_stage = "confirming_first"
  # Confirm the corrected first name spelling
  - action: utter_confirm_firstname_spelling
    # Bot: "Nathanael, spelled N-A-T-H-A-N-A-E-L. Did I get that right?"
  # User confirms first name is correct
  - intent: affirm # User: "Yes"
  # Handle confirmation, move to surname spelling
  - action: action_handle_spelling_confirmation
    # Bot: "Can you spell your last name letter-by-letter?"
    # Sets: spelling_stage = "spelling_last"
  # User spells their surname
  - intent: spell_name # User: "W-A-R-R-E-N"
  # Process the surname spelling
  - action: action_process_spelling
    # Sets: imprint_surname = "Warren"
    # Sets: surname_spelled = "W-A-R-R-E-N"
    # Sets: spelling_stage = "confirming_last"
  # Confirm the surname spelling
  - action: utter_confirm_surname_spelling
    # Bot: "Warren, spelled W-A-R-R-E-N. Did I get that right?"
  # User confirms surname is correct
  - intent: affirm # User: "Yes"
  # Handle final confirmation
  - action: action_handle_spelling_confirmation
    # Bot: "Great!"
    # Sets: spelling_stage = "complete"
    # Sets: name_complete = True
  # Combine corrected names into imprint_name for database query
  - action: action_set_imprint_name
    # Sets: imprint_name = "Nathanael_Warren"

- story: name collection - firstname spelling retry
  steps:
  - action: utter_ask_spell_firstname
  - intent: spell_name
  - action: action_process_spelling
  - action: utter_confirm_firstname_spelling
  - intent: deny
  - action: action_handle_spelling_confirmation
  # Loops back to utter_ask_spell_firstname

- story: name collection - surname spelling retry
  steps:
  - action: utter_ask_spell_surname
  - intent: spell_name
  - action: action_process_spelling
  - action: utter_confirm_surname_spelling
  - intent: deny
  - action: action_handle_spelling_confirmation
  # Loops back to utter_ask_spell_surname
